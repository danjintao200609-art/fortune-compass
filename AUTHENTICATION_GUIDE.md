# ç”¨æˆ·è®¤è¯åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬åº”ç”¨å·²å®ç°å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼Œ**ç¡®ä¿åªæœ‰æ³¨å†Œç”¨æˆ·æ‰èƒ½ç™»å½•å’Œä½¿ç”¨åº”ç”¨**ã€‚

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. æœªæ³¨å†Œç”¨æˆ·æ— æ³•ç™»å½•

å½“ç”¨æˆ·å°è¯•ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šæ‰§è¡Œä»¥ä¸‹éªŒè¯ï¼š

1. **ç”¨æˆ·å­˜åœ¨æ€§æ£€æŸ¥**
   - ç³»ç»Ÿä¼šåœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾ç”¨æˆ·ï¼ˆé€šè¿‡é‚®ç®±æˆ–æ‰‹æœºå·ï¼‰
   - å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ï¼š"é‚®ç®±/æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"
   - ä¸ºäº†å®‰å…¨æ€§ï¼Œä¸ä¼šé€éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨

2. **è´¦æˆ·çŠ¶æ€æ£€æŸ¥**
   - æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«ç¦ç”¨ï¼ˆ`is_active` å­—æ®µï¼‰
   - è¢«ç¦ç”¨çš„è´¦æˆ·æ— æ³•ç™»å½•

3. **å¯†ç éªŒè¯**
   - ä½¿ç”¨ bcrypt åŠ å¯†ç®—æ³•éªŒè¯å¯†ç 
   - å¯†ç é”™è¯¯æ—¶è¿”å›ç›¸åŒçš„é”™è¯¯æ¶ˆæ¯

### 2. æ³¨å†ŒéªŒè¯

æ³¨å†Œæ—¶ä¼šè¿›è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

- âœ… ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥
- âœ… é‚®ç®±å”¯ä¸€æ€§æ£€æŸ¥ï¼ˆå¦‚æœæä¾›ï¼‰
- âœ… æ‰‹æœºå·å”¯ä¸€æ€§æ£€æŸ¥ï¼ˆå¦‚æœæä¾›ï¼‰
- âœ… å¯†ç é•¿åº¦éªŒè¯ï¼ˆè‡³å°‘6ä½ï¼‰
- âœ… å¿…é¡»æä¾›é‚®ç®±æˆ–æ‰‹æœºå·ä¹‹ä¸€

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•åœºæ™¯ 1ï¼šæœªæ³¨å†Œç”¨æˆ·å°è¯•ç™»å½•

1. æ‰“å¼€åº”ç”¨ï¼Œè¿›å…¥ç™»å½•é¡µé¢
2. è¾“å…¥ä¸€ä¸ª**æœªæ³¨å†Œçš„é‚®ç®±æˆ–æ‰‹æœºå·**
3. è¾“å…¥ä»»æ„å¯†ç 
4. ç‚¹å‡»"ç™»å½•"æŒ‰é’®

**é¢„æœŸç»“æœ**ï¼š
- âŒ ç™»å½•å¤±è´¥
- æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼š"é‚®ç®±/æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"
- åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š`[ç™»å½•å¤±è´¥] ç”¨æˆ·ä¸å­˜åœ¨: xxx`

### æµ‹è¯•åœºæ™¯ 2ï¼šæ³¨å†Œåç™»å½•

1. ç‚¹å‡»"ç«‹å³æ³¨å†Œ"
2. å¡«å†™æ³¨å†Œä¿¡æ¯ï¼š
   - ç”¨æˆ·åï¼š`testuser`
   - é‚®ç®±ï¼š`test@example.com`
   - å¯†ç ï¼š`password123`
3. ç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®
4. æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ³¨å†ŒæˆåŠŸ
- âœ… è‡ªåŠ¨ç™»å½•å¹¶è¿›å…¥åº”ç”¨ä¸»é¡µ
- åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š`[æ³¨å†ŒæˆåŠŸ] ç”¨æˆ·: testuser, ID: xxx`

### æµ‹è¯•åœºæ™¯ 3ï¼šå·²æ³¨å†Œç”¨æˆ·ç™»å½•

1. ä½¿ç”¨å·²æ³¨å†Œçš„è´¦å·ä¿¡æ¯ç™»å½•
2. è¾“å…¥æ­£ç¡®çš„é‚®ç®±/æ‰‹æœºå·å’Œå¯†ç 

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç™»å½•æˆåŠŸ
- è¿›å…¥åº”ç”¨ä¸»é¡µ
- åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š`[ç™»å½•æˆåŠŸ] ç”¨æˆ·: xxx, ID: xxx`

### æµ‹è¯•åœºæ™¯ 4ï¼šå¯†ç é”™è¯¯

1. ä½¿ç”¨å·²æ³¨å†Œçš„é‚®ç®±/æ‰‹æœºå·
2. è¾“å…¥**é”™è¯¯çš„å¯†ç **

**é¢„æœŸç»“æœ**ï¼š
- âŒ ç™»å½•å¤±è´¥
- æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼š"é‚®ç®±/æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"
- åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š`[ç™»å½•å¤±è´¥] å¯†ç é”™è¯¯: xxx`

## ğŸ“Š æ—¥å¿—è®°å½•

ç³»ç»Ÿä¼šè®°å½•ä»¥ä¸‹è®¤è¯äº‹ä»¶ï¼ˆåœ¨åç«¯æ§åˆ¶å°ï¼‰ï¼š

### ç™»å½•æ—¥å¿—
```
[ç™»å½•å°è¯•] ç±»å‹: email, æ ‡è¯†ç¬¦: user@example.com
[ç™»å½•æˆåŠŸ] ç”¨æˆ·: testuser, ID: 123e4567-e89b-12d3-a456-426614174000
```

æˆ–

```
[ç™»å½•å°è¯•] ç±»å‹: phone, æ ‡è¯†ç¬¦: 13800138000
[ç™»å½•å¤±è´¥] ç”¨æˆ·ä¸å­˜åœ¨: 13800138000
```

### æ³¨å†Œæ—¥å¿—
```
[æ³¨å†Œå°è¯•] ç”¨æˆ·å: testuser, é‚®ç®±: test@example.com, æ‰‹æœº: æ— 
[æ³¨å†ŒæˆåŠŸ] ç”¨æˆ·: testuser, ID: 123e4567-e89b-12d3-a456-426614174000
```

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯ï¼ˆ`server/src/services/authService.ts`ï¼‰

```typescript
// ç™»å½•éªŒè¯æµç¨‹
export const loginUser = async (data: LoginData) => {
    // 1. æŸ¥è¯¢ç”¨æˆ·
    const { data: userData, error } = await query.single();
    
    // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    if (error || !userData) {
        return { error: 'é‚®ç®±/æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯' };
    }
    
    // 3. æ£€æŸ¥è´¦æˆ·çŠ¶æ€
    if (!userData.is_active) {
        return { error: 'è´¦æˆ·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜' };
    }
    
    // 4. éªŒè¯å¯†ç 
    const isPasswordValid = await verifyPassword(data.password, userData.password_hash);
    if (!isPasswordValid) {
        return { error: 'é‚®ç®±/æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯' };
    }
    
    // 5. ç”Ÿæˆ Token å¹¶è¿”å›
    return { user, token };
};
```

### å‰ç«¯ï¼ˆ`src/services/auth.ts`ï¼‰

```typescript
// ç™»å½•å‡½æ•°
export const login = async (data: LoginData) => {
    const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
    });
    
    const result = await response.json();
    
    if (!response.ok) {
        return { error: result.error };
    }
    
    // ä¿å­˜ token å’Œç”¨æˆ·ä¿¡æ¯
    localStorage.setItem('auth_token', result.token);
    localStorage.setItem('auth_user', JSON.stringify(result.user));
    
    return { user: result.user, token: result.token };
};
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

1. **å¯†ç åŠ å¯†**ï¼šä½¿ç”¨ bcrypt ç®—æ³•åŠ å¯†å­˜å‚¨
2. **JWT Token**ï¼šä½¿ç”¨ JWT è¿›è¡Œä¼šè¯ç®¡ç†ï¼Œæœ‰æ•ˆæœŸ 7 å¤©
3. **é”™è¯¯æ¶ˆæ¯æ¨¡ç³ŠåŒ–**ï¼šä¸é€éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢ç”¨æˆ·æšä¸¾æ”»å‡»
4. **è´¦æˆ·ç¦ç”¨åŠŸèƒ½**ï¼šæ”¯æŒç®¡ç†å‘˜ç¦ç”¨è´¦æˆ·
5. **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰è®¤è¯å°è¯•ï¼Œä¾¿äºå®‰å…¨å®¡è®¡

## ğŸ“ æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE auth_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username TEXT UNIQUE NOT NULL,
  email TEXT UNIQUE,
  phone TEXT UNIQUE,
  password_hash TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_login TIMESTAMPTZ,
  is_active BOOLEAN DEFAULT TRUE,
  CONSTRAINT check_email_or_phone CHECK (email IS NOT NULL OR phone IS NOT NULL)
);
```

## âœ… æ€»ç»“

âœ¨ **æ‚¨çš„åº”ç”¨å·²ç»å®Œå…¨å®ç°äº†"æœªæ³¨å†Œç”¨æˆ·ä¸èƒ½ç™»å½•"çš„åŠŸèƒ½ï¼**

- åç«¯ä¼šéªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
- å¯†ç éªŒè¯ä½¿ç”¨å®‰å…¨çš„åŠ å¯†ç®—æ³•
- é”™è¯¯æ¶ˆæ¯ä¸ä¼šæ³„éœ²æ•æ„Ÿä¿¡æ¯
- å®Œæ•´çš„æ—¥å¿—è®°å½•ä¾¿äºè°ƒè¯•å’Œå®¡è®¡
- æ”¯æŒè´¦æˆ·ç¦ç”¨åŠŸèƒ½

å¦‚éœ€è¿›ä¸€æ­¥å¢å¼ºå®‰å…¨æ€§ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- æ·»åŠ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰
- å®ç°éªŒè¯ç åŠŸèƒ½
- æ·»åŠ åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰
- å®ç°å¯†ç é‡ç½®åŠŸèƒ½
