# 认证系统测试指南

## 测试流程

### 1. 启动后端服务器
```bash
cd server
npm run dev
```

### 2. 启动前端
```bash
npm run dev
```

### 3. 测试注册功能

#### 测试用例 1: 正常注册
1. 打开浏览器访问应用
2. 点击"立即注册"
3. 填写信息:
   - 用户名: testuser1
   - 选择邮箱或手机号
   - 邮箱: test1@example.com 或 手机: 13800138001
   - 密码: password123
   - 确认密码: password123
4. 点击"立即注册"
5. **预期结果**: 注册成功，自动登录到应用主页

#### 测试用例 2: 重复用户名
1. 退出登录
2. 尝试用相同用户名注册
3. **预期结果**: 显示错误"用户名已被使用"

#### 测试用例 3: 重复邮箱/手机
1. 退出登录
2. 使用不同用户名但相同邮箱/手机注册
3. **预期结果**: 显示错误"邮箱已被注册"或"手机号已被注册"

#### 测试用例 4: 密码不一致
1. 填写注册信息
2. 两次密码输入不同
3. **预期结果**: 显示错误"两次输入的密码不一致"

### 4. 测试登录功能

#### 测试用例 1: 正确密码登录
1. 点击"立即登录"
2. 输入注册时的邮箱/手机号
3. 输入正确的密码
4. 点击"登录"
5. **预期结果**: 登录成功，进入应用主页

#### 测试用例 2: 错误密码登录
1. 点击"立即登录"
2. 输入注册时的邮箱/手机号
3. 输入**错误的**密码
4. 点击"登录"
5. **预期结果**: 显示错误"邮箱/手机号或密码错误"

#### 测试用例 3: 不存在的用户
1. 点击"立即登录"
2. 输入不存在的邮箱/手机号
3. 输入任意密码
4. 点击"登录"
5. **预期结果**: 显示错误"邮箱/手机号或密码错误"

### 5. 测试Token持久化

1. 登录成功后
2. 刷新页面 (F5)
3. **预期结果**: 用户仍然保持登录状态，不需要重新登录

### 6. 测试登出功能

1. 点击"设置"页面
2. 点击"退出登录"
3. **预期结果**: 返回登录页面，localStorage中的token被清除

## 数据库验证

### 检查用户是否正确存储

在Supabase控制台或通过SQL查询：

```sql
SELECT id, username, email, phone, password_hash, created_at, is_active
FROM auth_users
ORDER BY created_at DESC
LIMIT 10;
```

**验证点**:
- password_hash 应该是加密后的哈希值（不是明文）
- 哈希值应该类似: `$2a$10$...` (bcrypt格式)

### 检查会话表（可选）

```sql
SELECT s.id, s.user_id, u.username, s.expires_at, s.created_at
FROM auth_sessions s
JOIN auth_users u ON s.user_id = u.id
ORDER BY s.created_at DESC
LIMIT 10;
```

## 安全特性验证

### ✅ 已实现的安全特性：

1. **密码加密**: bcrypt with salt (10 rounds)
2. **密码最小长度**: 6个字符
3. **JWT Token**: 7天有效期
4. **错误信息**: 登录失败不暴露用户是否存在
5. **用户名唯一性**: 数据库级约束
6. **邮箱/手机唯一性**: 数据库级约束

### ⚠️ 建议改进（未来优化）:

1. 密码强度验证（大小写+数字+特殊字符）
2. 登录失败次数限制（防暴力破解）
3. Token刷新机制
4. 双因素认证（2FA）
5. 邮箱/手机号验证
6. 密码重置功能

## 常见问题排查

### 问题1: 注册后无法登录
- 检查后端日志，确认密码是否被正确加密和存储
- 检查数据库中的password_hash字段

### 问题2: Token验证失败
- 检查JWT_SECRET环境变量是否一致
- 检查Token是否过期
- 检查localStorage中是否正确存储了token

### 问题3: 密码验证总是失败
- 确认bcrypt版本兼容性
- 检查密码加密和验证时使用的是同一个bcrypt实例
- 查看后端日志中的详细错误信息
