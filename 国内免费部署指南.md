# 国内免费部署指南

## 项目结构概述
- **前端**: React 19 + TypeScript + Vite
- **后端**: Node.js + Express + TypeScript
- **数据库**: Supabase (已配置)

## 部署方案推荐

### 方案1: 前后端分离部署

#### 前端部署（静态网站）

**推荐平台:**
1. **Vercel**
   - 优点: 免费、自动部署、国内访问速度尚可、支持Vite项目
   - 缺点: 国外平台，某些地区可能较慢
   - 部署步骤:
     ```bash
     # 1. 安装Vercel CLI
     npm install -g vercel
     
     # 2. 登录Vercel
     vercel login
     
     # 3. 部署前端
     cd 项目根目录
     vercel --prod
     ```

2. **腾讯云开发静态网站托管**
   - 优点: 国内平台，访问速度快、免费额度高
   - 缺点: 需要实名认证
   - 部署步骤:
     ```bash
     # 1. 安装腾讯云开发CLI
     npm install -g @cloudbase/cli
     
     # 2. 登录
     tcb login
     
     # 3. 创建环境
     tcb env:create fortune-compass
     
     # 4. 构建前端
     npm run build
     
     # 5. 部署
     tcb hosting:deploy dist -e 环境ID
     ```

3. **阿里云OSS + CDN**
   - 优点: 国内访问速度快、免费额度大
   - 缺点: 配置稍复杂
   - 部署步骤:
     - 登录阿里云控制台，创建OSS Bucket
     - 开启静态网站托管
     - 构建前端: `npm run build`
     - 上传dist目录到OSS
     - 配置CDN加速

#### 后端部署（Node.js服务）

**推荐平台:**
1. **腾讯云函数(SCF)**
   - 优点: 免费额度高、无需管理服务器、支持Node.js
   - 缺点: 冷启动延迟
   - 部署步骤:
     ```bash
     # 1. 进入后端目录
     cd server
     
     # 2. 安装依赖
     npm install
     
     # 3. 构建
     npm run build
     
     # 4. 安装serverless框架
     npm install -g serverless
     
     # 5. 创建serverless.yml配置文件
     touch serverless.yml
     ```
     
     serverless.yml配置示例:
     ```yaml
     component: scf
     name: fortune-compass-api
     
     inputs:
       name: fortune-compass-api
       enableRoleAuth: true
       runtime: Nodejs18.16
       region: ap-guangzhou
       src: ./dist
       handler: app.handler
       events:
         - apigw:
             parameters:
               endpoints:
                 - path: /
                   method: ANY
                   function: fortune-compass-api
     ```

2. **阿里云函数计算(FC)**
   - 优点: 免费额度高、性能好
   - 缺点: 配置稍复杂
   - 部署步骤:
     - 登录阿里云控制台，创建函数计算服务
     - 选择Node.js运行时
     - 上传构建后的dist目录
     - 配置HTTP触发器

3. **腾讯云轻量应用服务器**
   - 优点: 完全控制、适合学习
   - 缺点: 需要自己维护服务器
   - 部署步骤:
     - 申请学生免费服务器
     - 安装Node.js 18+
     - 上传后端代码
     - 安装依赖并构建
     - 使用PM2管理进程
     ```bash
     # 安装PM2
     npm install -g pm2
     
     # 启动服务
     pm2 start dist/app.js --name fortune-compass-api
     
     # 设置开机自启
     pm2 startup
     pm2 save
     ```

### 方案2: 一体化部署（推荐）

**推荐平台: 腾讯云开发**

- 优点: 前后端一体化、无需管理服务器、国内访问速度快、免费额度高
- 缺点: 需要实名认证

**部署步骤:**

1. **创建云开发环境**
   - 登录腾讯云控制台
   - 进入云开发服务
   - 创建环境，选择"按量计费" + "基础版"

2. **配置云函数**
   - 进入环境的云函数管理
   - 创建函数，选择"从头开始"
   - 运行时选择"Node.js 18.16"
   - 上传后端代码（构建后的dist目录）
   - 配置入口函数为 `app.handler`

3. **配置HTTP触发器**
   - 为云函数添加HTTP触发器
   - 选择"发布"环境
   - 开启"集成响应"

4. **部署前端**
   - 进入环境的静态网站托管
   - 构建前端: `npm run build`
   - 上传dist目录

5. **配置环境变量**
   - 在云函数配置中添加环境变量:
     - `SUPABASE_URL`: 你的Supabase URL
     - `SUPABASE_KEY`: 你的Supabase Key
     - `GEMINI_API_KEY`: 你的Gemini API Key
     - `JWT_SECRET`: 用于JWT签名的密钥

### 方案3: 字节跳动云开发

- 优点: 国内平台、免费额度高、支持前后端一体化
- 缺点: 生态相对较小

**部署步骤:**
1. 登录字节跳动云开发控制台
2. 创建环境
3. 部署前端静态网站
4. 部署后端云函数
5. 配置环境变量

## 环境变量配置

### 前端环境变量
在 `.env` 文件中配置:
```
VITE_SUPABASE_URL=你的Supabase URL
VITE_SUPABASE_ANON_KEY=你的Supabase Anon Key
VITE_API_URL=你的后端API地址
```

### 后端环境变量
在 `.env` 文件中配置:
```
PORT=3000
SUPABASE_URL=你的Supabase URL
SUPABASE_KEY=你的Supabase Key
GEMINI_API_KEY=你的Gemini API Key
JWT_SECRET=用于JWT签名的密钥
```

## 数据库配置

项目已使用Supabase作为数据库，无需额外配置。如果需要国内数据库，可以考虑:

1. **腾讯云PostgreSQL**
   - 优点: 国内访问速度快、稳定可靠
   - 缺点: 免费额度有限

2. **阿里云PostgreSQL**
   - 优点: 国内访问速度快、生态完善
   - 缺点: 免费额度有限

## 部署验证

1. **前端访问**
   - 打开部署后的前端URL，检查页面是否正常加载
   - 测试注册、登录功能

2. **后端API测试**
   - 使用Postman或curl测试后端API
   - 测试认证流程: 注册 → 登录 → 获取token → 访问受保护接口

3. **完整流程测试**
   - 注册新用户
   - 登录
   - 测试核心功能（如运势查询）
   - 测试数据持久化（如个人资料保存）

## 常见问题排查

1. **跨域问题**
   - 后端需配置CORS中间件，允许前端域名访问
   - 在 `server/src/app.ts` 中确保已配置:
     ```typescript
     app.use(cors({
       origin: ['前端域名1', '前端域名2'],
       credentials: true
     }));
     ```

2. **环境变量不生效**
   - 确保部署时已正确配置环境变量
   - 检查变量名是否大小写一致

3. **构建失败**
   - 确保本地能正常构建: `npm run build`
   - 检查依赖是否完整: `npm install`

4. **后端服务无法启动**
   - 检查日志文件
   - 确保端口未被占用
   - 检查数据库连接配置

## 推荐方案总结

| 方案 | 优点 | 缺点 | 适合人群 |
|------|------|------|----------|
| Vercel + 腾讯云函数 | 配置简单、免费额度高 | 需管理两个平台 | 快速部署需求 |
| 腾讯云开发一体化 | 前后端一体化、国内速度快 | 需要实名认证 | 长期稳定使用 |
| 阿里云OSS + 函数计算 | 国内访问速度快、免费额度大 | 配置稍复杂 | 技术能力较强者 |

根据你的需求和技术水平，选择最适合的部署方案。建议优先考虑**腾讯云开发一体化**方案，它提供了完整的前后端部署能力，且国内访问速度快，免费额度充足。