# 个人资料保存功能测试指南

## 🎯 测试目标

验证个人资料修改后能够正确保存到数据库，并在第二次登录后能够正确加载。

## ✅ 修复内容

### 1. 后端修改
- ✅ `profileController.ts` - 使用认证中间件的用户ID
- ✅ 添加详细日志输出
- ✅ 修复日期格式问题

### 2. 前端修改  
- ✅ `api.ts` - 使用 Authorization Bearer Token
- ✅ 添加详细日志输出
- ✅ 正确传递认证信息

### 3. UI更新
- ✅ 登录页面 - 使用新logo和应用名称"兄弟运势测评"
- ✅ 注册页面 - 使用新logo
- ✅ HTML标题 - 改为"兄弟运势测评"

## 📋 测试步骤

### 步骤 1: 登录账号

1. 打开浏览器: http://localhost:5173
2. 使用已注册的账号登录
3. 应该看到新的logo图片和"兄弟运势测评"标题

### 步骤 2: 修改个人资料

1. 点击底部导航的 **"设置"** 图标
2. 修改以下信息:
   - 昵称: 改为 "测试用户123"
   - 生日: 改为 "1995-06-15"
   - 性别: 改为 "女"
3. 点击 **"保存"** 按钮
4. **检查浏览器控制台**，应该看到:
   ```
   [updateProfile] 更新数据: {nickname: "测试用户123", birthday: "1995-06-15", gender: "female"}
   [updateProfile] 成功更新: {...}
   ```

### 步骤 3: 退出登录

1. 在设置页面，点击 **"退出登录"**
2. 应该返回到登录页面

### 步骤 4: 重新登录

1. 使用相同账号重新登录
2. **关键测试**: 登录后自动加载个人资料
3. **检查浏览器控制台**，应该看到:
   ```
   [getProfile] 成功获取: {id: "...", nickname: "测试用户123", birthday: "1995-06-15", gender: "female"}
   ```

### 步骤 5: 验证数据持久化

1. 点击 **"设置"** 查看个人资料
2. **验证点**:
   - ✅ 昵称应该是 "测试用户123"
   - ✅ 生日应该是 "1995-06-15"
   - ✅ 性别应该是 "女"
3. **如果数据正确显示，说明保存成功！** 🎉

## 🔍 数据库验证

### 在 Supabase 中查看数据

1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 运行查询:

```sql
SELECT 
    p.id,
    u.username,
    u.email,
    p.nickname,
    p.birthday,
    p.gender,
    p.created_at,
    p.updated_at
FROM profiles p
JOIN auth_users u ON p.id = u.id
ORDER BY p.updated_at DESC
LIMIT 10;
```

4. **验证点**:
   - `nickname` 字段应该是您修改的值
   - `birthday` 字段应该是您设置的日期
   - `gender` 字段应该是您选择的性别
   - `updated_at` 应该是最近的时间戳

## 🐛 故障排查

### 问题 1: 保存后没有反应

**检查**:
1. 打开浏览器开发者工具 (F12)
2. 查看 Console 标签页
3. 查看 Network 标签页，找到 `/api/profile` 请求
4. 检查请求是否成功 (状态码 200)

**可能原因**:
- Token 过期或无效
- 网络请求失败
- 后端服务器未运行

### 问题 2: 第二次登录数据丢失

**检查**:
1. 查看浏览器控制台的 `[getProfile]` 日志
2. 检查返回的数据是否为空对象 `{}`
3. 查看 Network 标签页的响应内容

**可能原因**:
- 数据库中没有该用户的 profile 记录
- 用户ID不匹配
- Token 验证失败

### 问题 3: 控制台显示 401 错误

**原因**: Token 无效或未提供

**解决**:
1. 退出登录
2. 重新登录获取新的 Token
3. 再次尝试修改个人资料

## 📊 成功标志

如果看到以下情况，说明功能正常：

✅ **保存时**:
```
[updateProfile] 更新数据: {...}
[updateProfile] 成功更新: {...}
```

✅ **登录时**:
```
[getProfile] 成功获取: {...}
```

✅ **数据库中**:
- profiles 表有对应记录
- 数据与修改的一致
- updated_at 时间戳正确

## 🎨 UI 更新验证

### 新Logo和应用名称

✅ **登录页面**:
- 显示圆形头像照片（电梯里的照片）
- 标题显示 "兄弟运势测评"

✅ **注册页面**:
- 显示圆形头像照片
- 标题显示 "注册新账号"

✅ **浏览器标签页**:
- 标题显示 "兄弟运势测评"

## 🚀 技术细节

### 认证流程

1. **登录** → 获得 JWT Token → 存储到 localStorage
2. **API调用** → 从 localStorage 读取 Token → 添加到 Authorization header
3. **后端验证** → authMiddleware 验证 Token → 提取用户ID
4. **数据操作** → 使用认证的用户ID → 读写 profiles 表

### 数据流

```
前端 (App.tsx)
  ↓ 调用 api.updateProfile()
前端 API (api.ts)
  ↓ 添加 Authorization: Bearer <token>
后端路由 (fortuneRoutes.ts)
  ↓ authMiddleware 验证
后端控制器 (profileController.ts)
  ↓ req.user.id
数据库 (Supabase profiles 表)
```

---

**测试完成后，请确认**:
- ✅ 个人资料可以保存
- ✅ 第二次登录能加载数据
- ✅ 新logo和应用名称正确显示

**祝测试顺利！** 🎉
